<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SportTime.Views.MainPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:SportTime.Models"
             xmlns:viewmodels="clr-namespace:SportTime.ViewModels"
             x:DataType="viewmodels:MainViewModel"
             Title="ðŸ“ ToDo List">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        
        <!-- Qidirish va filtrlash bo'limi -->
        <Frame Grid.Row="0" 
               BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
               Padding="15"
               Margin="10,10,10,5"
               CornerRadius="12"
               HasShadow="True">
            
            <StackLayout Spacing="10">
                <!-- Qidirish maydoni -->
                <SearchBar x:Name="SearchBar"
                          Placeholder="Vazifalarni qidirish..."
                          Text="{Binding SearchText}"
                          BackgroundColor="Transparent"
                          PlaceholderColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                
                <!-- Filtrlash tugmalari -->
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <CheckBox IsChecked="{Binding ShowCompletedOnly}" 
                              Color="{StaticResource Primary}" />
                    <Label Text="Faqat bajarilganlarni ko'rsatish" 
                           VerticalOptions="Center"
                           FontSize="14" />
                </StackLayout>
            </StackLayout>
        </Frame>

        <!-- Statistika -->
        <Frame Grid.Row="1"
               BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
               Padding="15"
               Margin="10,5"
               CornerRadius="12"
               HasShadow="True">
            
            <StackLayout Orientation="Horizontal" HorizontalOptions="SpaceEvenly">
                <StackLayout HorizontalOptions="Center">
                    <Label Text="{Binding Tasks.Count}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalTextAlignment="Center" />
                    <Label Text="Jami" 
                           FontSize="12"
                           TextColor="White"
                           HorizontalTextAlignment="Center" />
                </StackLayout>
                
                <BoxView WidthRequest="1" 
                         BackgroundColor="White" 
                         Opacity="0.5" />
                
                <StackLayout HorizontalOptions="Center">
                    <Label FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalTextAlignment="Center">
                        <Label.Text>
                            <Binding Path="Tasks">
                                <Binding.Converter>
                                    <local:CompletedTasksCountConverter />
                                </Binding.Converter>
                            </Binding>
                        </Label.Text>
                    </Label>
                    <Label Text="Bajarilgan" 
                           FontSize="12"
                           TextColor="White"
                           HorizontalTextAlignment="Center" />
                </StackLayout>
            </StackLayout>
        </Frame>

        <!-- Vazifalar ro'yxati -->
        <RefreshView Grid.Row="2" 
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding RefreshCommand}"
                     Margin="10,5">
            
            <CollectionView ItemsSource="{Binding FilteredTasks}"
                           BackgroundColor="Transparent">
                
                <CollectionView.EmptyView>
                    <StackLayout HorizontalOptions="Center" 
                                VerticalOptions="Center"
                                Padding="20">
                        <Label Text="ðŸ“‹" 
                               FontSize="48"
                               HorizontalTextAlignment="Center" />
                        <Label Text="Hozircha vazifalar yo'q" 
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="Center"
                               Margin="0,10,0,5" />
                        <Label Text="Yangi vazifa qo'shish uchun + tugmasini bosing" 
                               FontSize="14"
                               TextColor="{StaticResource Gray500}"
                               HorizontalTextAlignment="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TaskModel">
                        <Frame Padding="0" 
                               Margin="0,5"
                               CornerRadius="12"
                               HasShadow="True"
                               BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}">
                            
                            <Grid ColumnDefinitions="Auto,*,Auto" 
                                  Padding="15"
                                  RowSpacing="8">
                                
                                <!-- Bajarilganlik belgisi -->
                                <CheckBox Grid.Column="0"
                                         IsChecked="{Binding IsCompleted}"
                                         Color="{StaticResource Primary}"
                                         VerticalOptions="Start"
                                         Margin="0,5,10,0">
                                    <CheckBox.Behaviors>
                                        <EventTrigger Event="CheckedChanged">
                                            <InvokeCommandAction Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ToggleCompletionCommand}"
                                                               CommandParameter="{Binding .}" />
                                        </EventTrigger>
                                    </CheckBox.Behaviors>
                                </CheckBox>

                                <!-- Vazifa ma'lumotlari -->
                                <StackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="{Binding Title}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" 
                                                        Binding="{Binding IsCompleted}" 
                                                        Value="True">
                                                <Setter Property="TextDecorations" Value="Strikethrough" />
                                                <Setter Property="TextColor" Value="{StaticResource Gray500}" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                    
                                    <Label Text="{Binding Description}"
                                           FontSize="14"
                                           TextColor="{StaticResource Gray600}"
                                           IsVisible="{Binding Description, Converter={StaticResource StringToBoolConverter}}" />
                                    
                                    <!-- Muddat va holat -->
                                    <StackLayout Orientation="Horizontal" Spacing="15">
                                        <Label FontSize="12" 
                                               TextColor="{StaticResource Gray500}"
                                               IsVisible="{Binding DueDate, Converter={StaticResource NullToBoolConverter}}">
                                            <Label.Text>
                                                <MultiBinding StringFormat="ðŸ“… {0:dd.MM.yyyy}">
                                                    <Binding Path="DueDate" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                        
                                        <Label Text="âœ… Bajarilgan"
                                               FontSize="12"
                                               TextColor="{StaticResource Primary}"
                                               IsVisible="{Binding IsCompleted}" />
                                    </StackLayout>
                                </StackLayout>

                                <!-- Amallar tugmalari -->
                                <StackLayout Grid.Column="2" 
                                           Orientation="Horizontal" 
                                           Spacing="5"
                                           VerticalOptions="Start">
                                    
                                    <ImageButton Source="edit_icon.png"
                                               WidthRequest="32"
                                               HeightRequest="32"
                                               BackgroundColor="Transparent"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=EditTaskCommand}"
                                               CommandParameter="{Binding .}">
                                        <ImageButton.Triggers>
                                            <DataTrigger TargetType="ImageButton" 
                                                        Binding="{Binding IsCompleted}" 
                                                        Value="True">
                                                <Setter Property="Opacity" Value="0.5" />
                                            </DataTrigger>
                                        </ImageButton.Triggers>
                                    </ImageButton>
                                    
                                    <ImageButton Source="delete_icon.png"
                                               WidthRequest="32"
                                               HeightRequest="32"
                                               BackgroundColor="Transparent"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=DeleteTaskCommand}"
                                               CommandParameter="{Binding .}" />
                                </StackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Yangi vazifa qo'shish tugmasi -->
        <Button Grid.Row="3"
                Text="âž• Yangi vazifa qo'shish"
                FontSize="16"
                FontAttributes="Bold"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                CornerRadius="25"
                HeightRequest="50"
                Margin="20,10,20,20"
                Command="{Binding AddTaskCommand}" />
    </Grid>
</ContentPage>